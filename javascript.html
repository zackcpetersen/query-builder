<script>
    let filters = []
    let query = '';

    function addMessage(error) {
        if (error) {
            $('#error').show()
                .html(error)
                .css('color', 'red');
        } else {
            $('#error').hide();
        }

    }

    const myRunner = google.script.run.withFailureHandler(addMessage);

    function getFormData(checkSheet = false) {
        // TODO update this to only grab sheet, range and long query
        let formInputs = Array.from(document.querySelectorAll('#queryForm input, textarea, checkbox'))
            .reduce((acc, input) => ({...acc, [input.id]: input.value}), {})

        formInputs.cleanedQuery = formInputs.longQuery.replace(/\r?\n|\r/g, " ").replace(/\s+/g, ' ').trim()

        if ((checkSheet) && !(formInputs.dataSheet || formInputs.currentSheet === 'checked')) {
            addMessage('You must select a sheet!')
            throw 'You must select a sheet!';
        } else {
            if (formInputs.currentSheet === 'checked') {
                formInputs.useActiveSheet = 'true';
                formInputs.dataSheet = null;
            } else {
                formInputs.useActiveSheet = 'false';
            }

            return formInputs
        }
    }

    function callPicker() {
        getFormData();
        myRunner.picker();
    }

    function handleFormSubmit() {
        const formInputs = getFormData(true);
        myRunner.buildQuery(formInputs, query)
    }

    function updateInputs(data) {
        // TODO need to update this - maybe? only needs sheet, range, and longquery
        if (data.dataSheet) {
            const link = "'" + data.dataSheet + "'"
            $('#selectedSheetDiv').show().html(
                "<a href=" + link + " target=\"_blank\">" + data.sheetName + "</a>")

            $('#dataSheet').val(data.dataSheet)
        }
        if (data.myRange) {
            $('#myRange').val(data.myRange)
        }
        if (data.cleanedQuery) {
            $('#longQuery').val(data.cleanedQuery)
        }
        if (data.useActiveSheet == 'true') {
            $('#currentSheet').prop('checked', true)
        }
        // TODO finish filling in cache data
    }

    function updateRange(range) {
        $('#myRange').val(range);
    }


    function requiredElements(elements, required) {
        for (let i = 0; i < elements.length; i++) {
            elements[i].required = required
        }
    }

    function clearFilters() {
        $('#column').val(null);
        $('#compareInput').val('=');
        $('#value').val(null);
        $('#isCell').prop('checked', false);
        $('#isDate').prop('checked', false);
    }

    function getChain(filters, i) {
        if (i === 0) {
            return ''
        } else if (filters[i].chain) {
            return filters[i].chain;
        } else {
            return 'AND'
        }
    }

    function formatValue(filter) {
        if (filter.date) {
            return formatForDate(filter);
        } else if (filter.cell) {
            return formatForCell(filter.val);
        } else {
            if (typeof parseInt(filter.val) === 'number' && !isNaN(parseInt(filter.val))) {
                return filter.val
            }
            return addSingleQuotes(filter.val)
        }
    }

    function buildWalkthroughQuery(filters) {
        let query = 'WHERE '
        for (let i = 0; i < filters.length; i++) {
            let chain = getChain(filters, i)
            let val = formatValue(filters[i])
            query += ''.concat(chain, ' ', filters[i].column.toUpperCase(), ' ', filters[i].compareInput, ' ', val, ' ')
        }
        return query;
    }

    // Query value formatting
    function formatForDate(filter) {
        if (filter.cell) {
            return 'date ' + addSingleQuotes('"&text(datevalue(' + filter.val + '), "yyyy-mm-dd")&"')
        } else {
            return 'date ' + addSingleQuotes(filter.val)
        }
    }

    function formatForCell(value) {
        return "'\"&" + value + "&\"'"
    }

    function addSingleQuotes(value) {
        return "'" + value + "'"
    }

    $(document).ready(() => {
        myRunner.withSuccessHandler(updateInputs).getFromCache();

        let filterInputs = {}
        let chain = '';

        // watches for query form submit
        $('#queryForm').on('submit', () => {
            handleFormSubmit()
        })

        // watches checkbox for current sheet
        $('#currentSheet').on('click', () => {
            if ($('#currentSheet').prop('checked')) {
                $('#currentSheet').val('checked')
                myRunner.withSuccessHandler(updateRange).getActiveRange();
            } else {
                $('#currentSheet').val(null);
            }
        })

        // watches for helpCheckbox changes
        $('#help').on('change', () => {
            if ($('#help').prop('checked')) {
                $('#queryWalkthrough').show();
                $('#queryFreeForm').hide();
                $('#help').val('checked');
                $('#seeQuery').show();
                requiredElements($('#queryWalkthrough input'), true);
                requiredElements($('#queryFreeForm textarea'), false);
            } else {
                $('#queryWalkthrough').hide();
                $('#queryFreeForm').show();
                $('#help').val(null);
                $('#seeQuery').hide();
                requiredElements($('#queryWalkthrough input'), false);
                requiredElements($('#queryFreeForm textarea'), true);
            }
        })

        // watches for show filter button changes
        $('#showFilter').on('click', () => {
            $('#queryFilters').show();
            $('#showFilter').prop('disabled', true)

            if (filters.length) {
                $('#andOrDiv').show()
            }
        })

        $('#clearQueryFilters').on('click', () => {
            filters = [];
            query = '';
            $('#seeQuery').html('');
        })

        $('#addFilter').on('click', () => {
            if (!($('#column').val() && $('#value').val())) {
                addMessage('You must fill out both "WHERE" and "VALUE" to continue!');
                throw 'You must fill out both "WHERE" and "VALUE" to continue!';
            } else {
                addMessage('')
            }

            filterInputs = {
                chain: chain,
                column: $('#column').val(),
                compareInput: $('#compareInput').val(),
                val: $('#value').val(),
                cell: $('#isCell').prop('checked'),
                date: $('#isDate').prop('checked')
            }
            filters.push(filterInputs);

            chain = null;
            clearFilters();

            $('#queryFilters').hide();
            $('#showFilter').prop('disabled', false)

            requiredElements($('#queryFilters input[type=text]'), true)
            query = buildWalkthroughQuery(filters);

            //this may not work
            $('#seeQuery').show()
                .html(query);
        })

        $('#closeFilterBox').on('click', () => {
            $('#queryFilters').hide();
            $('#showFilter').prop('disabled', false)

            chain = null;
            clearFilters();
        })

        // and / or button clicks
        $('#andButton').on('click', () => {
            chain = $('#andButton').val()
            $('#andButton').prop('disabled', true);
            $('#orButton').prop('disabled', false);
        })
        $('#orButton').on('click', () => {
            chain = $('#orButton').val()
            $('#andButton').prop('disabled', false);
            $('#orButton').prop('disabled', true);
        })

        // add message on isDate
        $('#isDate').on('click', () => {
            if ($('#isDate').prop('checked')) {
                $('#dateFormat').show()
            } else {
                $('#dateFormat').hide()
            }
        })
    })


    // TODO refactor event listener functions to call named functions instead of anonymous ones
</script>
