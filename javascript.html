<script>
    let filters = []
    let query = '';
    function addMessage(error) {
        const errorDiv = document.getElementById('error');
        errorDiv.hidden = false;
        errorDiv.innerHTML = error;
        errorDiv.style.color = 'red';
    }
    const myRunner = google.script.run.withFailureHandler(addMessage);

    function getFormData(checkSheet=false) {
        // TODO update this to only grab sheet, range and long query
        let formInputs = Array.from(document.querySelectorAll('#queryForm input, textarea, checkbox'))
            .reduce((acc, input) => ({...acc, [input.id]: input.value }), {})

        formInputs.cleanedQuery = formInputs.longQuery.replace(/\r?\n|\r/g, " ").replace(/\s+/g,' ').trim()

        if ((checkSheet) && !(formInputs.dataSheet || formInputs.currentSheet === 'checked')) {
            addMessage('You must select a sheet!')
            throw 'You must select a sheet!';
        } else {
            if (formInputs.currentSheet === 'checked') {
                formInputs.useActiveSheet = 'true';
                formInputs.dataSheet = null;
            } else {
                formInputs.useActiveSheet = 'false';
            }

            return formInputs
        }
    }

    function callPicker() {
        getFormData();
        //myRunner.picker();
    }

    function queryFilter(filter) {
        let queryFilter = '';
        queryFilter.concat(filter.chain, ' ', filter.column, ' ', filter.compareInput, ' ', filter.value, ' ');
        return queryFilter;
    }

    function handleFormSubmit() {
        const formInputs = getFormData(true);
        myRunner.buildQuery(formInputs, query)
    }

    function updateInputs(data) {
        // I would really love to run this through a loop and fill getElementById's dynamically
        // but having trouble making it work. It doesn't seem to like the id coming from an
        // object key (even if converted to a string)
        // TODO need to update this - maybe? only needs document, range, and longquery
        if (data.dataSheet) {
            const myDiv = document.getElementById('selectedSheetDiv');
            const link = "'" + data.dataSheet + "'"
            myDiv.hidden = false;
            myDiv.innerHTML += "<a href=" + link + " target=\"_blank\">" + data.sheetName + "</a>"

            document.getElementById('dataSheet').value = data.dataSheet;
        }
        if (data.myRange) {
            document.getElementById('myRange').value = data.myRange;
        }
        if (data.cleanedQuery) {
            document.getElementById('longQuery').value = data.cleanedQuery;
        }
        if (data.useActiveSheet == 'true') {
            document.getElementById('currentSheet').checked = true;
        }
    }

    function updateRange(range) {
        document.getElementById('myRange').value = range;
    }


    function requiredElements(elements, required) {
        elements.forEach(function (element) {
            element.required = required
        })
    }

    function getChain(filters, i) {
        if (i === 0) {
            return ''
        } else if (filters[i].chain) {
            return filters[i].chain;
        } else {
            return 'AND'
        }
    }

    function formatValue(filter) {
        if (filter.date) {
            return formatForDate(filter);
        } else if (filter.cell) {
            return formatForCell(filter.val);
        } else {
            return filter.val;
        }
    }

    function buildWalkthroughQuery(filters) {
        // TODO may need to check if value is str or int
        let query = 'WHERE '
        for (let i = 0; i < filters.length; i++) {
            let chain = getChain(filters, i)
            let val = formatValue(filters[i])
            query += ''.concat(chain, ' ', filters[i].column.toUpperCase(), ' ', filters[i].compareInput, ' ', val, ' ')
        }
        return query;
    }

    function formatForDate(filter) {
        if (filter.cell) {
            return 'date ' + addSingleQuotes('"&text(datevalue(' + filter.val + '), "yyyy-mm-dd")&"')
        } else {
            return 'date ' + addSingleQuotes(filter.val)
        }
    }

    function formatForCell(value) {
        return "'\"&" + value + "&\"'"
    }

    function addSingleQuotes(value) {
        return "'" + value + "'"
    }

    document.addEventListener('DOMContentLoaded', () => {
        myRunner.withSuccessHandler(updateInputs).getFromCache();

        let filterInputs = {}
        let chain = '';
        const currentSheetSelector = document.getElementById('currentSheet');
        currentSheetSelector.value = null;
        const dynamicRangeSelector = document.getElementById('dynamicRange');
        const myRangeInput = document.getElementById('myRange');
        const helpCheckbox = document.getElementById('help');
        const showFilter = document.getElementById('showFilter');
        const clearQueryFilters = document.getElementById('clearQueryFilters');
        const andOrDiv = document.getElementById('andOrDiv');
        const andButton = document.getElementById('andButton');
        const orButton = document.getElementById('orButton');
        const addFilter = document.getElementById('addFilter');
        const queryFilters = document.getElementById('queryFilters');
        const closeFilterBox = document.getElementById('closeFilterBox');
        const seeQuery = document.getElementById('seeQuery');
        const isDate = document.getElementById('isDate');
        const dateFormat = document.getElementById('dateFormat');

        // watches checkbox for current sheet
        currentSheetSelector.addEventListener('change', function () {
            if (currentSheetSelector.checked) {
                currentSheetSelector.value = 'checked'
                document.getElementById('dynamicRangePicker').hidden = false;
            } else {
                currentSheetSelector.value = null;
                document.getElementById('dynamicRangePicker').hidden = true;
                dynamicRangeSelector.checked = false;
                myRangeInput.disabled = false;
            }

            document.getElementById('dynamicRangePicker').hidden = !currentSheetSelector.checked;
        })

        // watches checkbox for dynamicRange checkbox
        dynamicRangeSelector.addEventListener('change', function () {
            myRunner.withSuccessHandler(updateRange).getActiveRange();
            myRangeInput.disabled = dynamicRangeSelector.checked;
        })

        // watches for helpCheckbox changes
        helpCheckbox.addEventListener('change', () => {
            const walkThrough = document.getElementById('queryWalkthrough');
            const freeForm = document.getElementById('queryFreeForm');
            if (helpCheckbox.checked) {
                walkThrough.hidden = false;
                freeForm.hidden = true;
                helpCheckbox.value = 'checked';
                seeQuery.hidden = false;
                requiredElements(document.querySelectorAll('#queryWalkthrough input'), true);
                requiredElements(document.querySelectorAll('#queryFreeForm textarea'), false);
            } else {
                walkThrough.hidden = true;
                freeForm.hidden = false;
                helpCheckbox.value = null;
                seeQuery.hidden = true;
                requiredElements(document.querySelectorAll('#queryWalkthrough input'), false);
                requiredElements(document.querySelectorAll('#queryFreeForm textarea'), true);
            }
        })

        // watches for show filter button changes
        showFilter.addEventListener('click', () => {
            queryFilters.hidden = false
            showFilter.disabled = true;
            if (filters.length) {
                andOrDiv.hidden = false;
            }
        })

        clearQueryFilters.addEventListener('click', (event) => {
            event.preventDefault();
            filters = [];
            query = '';
            seeQuery.innerHTML = filters;
        })

        addFilter.addEventListener('click', (event) => {
            // TODO need to make sure that this doesn't get empty values if form is incomplete - can use conditional
            event.preventDefault();
            filterInputs = {
                chain: chain,
                column: document.getElementById('column').value,
                compareInput: document.getElementById('compareInput').value,
                val: document.getElementById('value').value,
                cell: document.getElementById('isCell').checked,
                date: document.getElementById('isDate').checked
            }
            filters.push(filterInputs);

            // clear filters
            chain = null;
            document.getElementById('column').value = null;
            document.getElementById('compareInput').value = "=";
            document.getElementById('value').value = null;

            queryFilters.hidden = true
            showFilter.disabled = false;

            query = buildWalkthroughQuery(filters);
            seeQuery.hidden = false;
            seeQuery.innerHTML = query;
        })

        closeFilterBox.addEventListener('click', () => {
            queryFilters.hidden = true;
            showFilter.disabled = false;
            // clear filters
            chain = null;
            document.getElementById('column').value = null;
            document.getElementById('compareInput').value = "=";
            document.getElementById('value').value = null;
        })

        // and / or button clicks
        andButton.addEventListener('click', () => {
            chain = andButton.value;
            andButton.disabled = true;
            orButton.disabled = false;
        })
        orButton.addEventListener('click', () => {
            chain = orButton.value;
            orButton.disabled = true;
            andButton.disabled = false;
        })

        // add hover message on isDate
        isDate.addEventListener('click', () => {
            if (isDate.checked) {
                dateFormat.hidden = false;
            } else {
                dateFormat.hidden = true;
            }
        })
    });


    // TODO refactor event listener functions to call named functions instead of anonymous ones
    // TODO switch everything to jQuery?
</script>
